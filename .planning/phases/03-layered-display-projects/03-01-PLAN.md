---
phase: 03-layered-display-projects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app/layout.tsx
  - convex/events.ts
  - app/hooks/useProjectFilter.ts
autonomous: true

must_haves:
  truths:
    - "nuqs, react-collapsed, and shiki are installed and importable"
    - "NuqsAdapter wraps the app in layout.tsx"
    - "Unique projects can be queried from Convex"
    - "useProjectFilter hook syncs project state with URL"
  artifacts:
    - path: "app/hooks/useProjectFilter.ts"
      provides: "URL-synced project filter state"
      exports: ["useProjectFilter"]
    - path: "convex/events.ts"
      provides: "listProjects query"
      contains: "listProjects"
  key_links:
    - from: "app/layout.tsx"
      to: "nuqs/adapters/next/app"
      via: "NuqsAdapter wrapper"
      pattern: "NuqsAdapter"
    - from: "app/hooks/useProjectFilter.ts"
      to: "nuqs"
      via: "useQueryState hook"
      pattern: "useQueryState.*project"
---

<objective>
Install Phase 3 dependencies (nuqs, react-collapsed, shiki) and set up URL state infrastructure for project filtering.

Purpose: Enables URL-synced project filter (/live?project=name) and provides libraries for expand/collapse animation and syntax highlighting.
Output: Dependencies installed, NuqsAdapter configured, listProjects query, useProjectFilter hook.
</objective>

<execution_context>
@/Users/alexander.buss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander.buss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-layered-display-projects/03-RESEARCH.md

# Existing files to modify
@app/layout.tsx
@convex/events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure NuqsAdapter</name>
  <files>package.json, app/layout.tsx</files>
  <action>
1. Install required dependencies:
   ```bash
   bun add nuqs react-collapsed shiki
   ```

2. Update app/layout.tsx to wrap children with NuqsAdapter:
   - Import NuqsAdapter from 'nuqs/adapters/next/app'
   - Wrap {children} inside ConvexClientProvider with NuqsAdapter
   - Structure: ConvexClientProvider > NuqsAdapter > {children}

Reference RESEARCH.md Pattern: nuqs Setup (App Router) for correct import path.

Note: NuqsAdapter must wrap any components using useQueryState.
  </action>
  <verify>
- `bun run build` completes without errors
- `grep -r "NuqsAdapter" app/layout.tsx` shows the adapter is imported and used
  </verify>
  <done>nuqs, react-collapsed, and shiki installed; NuqsAdapter wraps app content in layout.tsx</done>
</task>

<task type="auto">
  <name>Task 2: Create listProjects query and useProjectFilter hook</name>
  <files>convex/events.ts, app/hooks/useProjectFilter.ts</files>
  <action>
1. Add listProjects query to convex/events.ts:
   - Query distinct projectName values from events table
   - Return array of objects: { name: string, lastActivity: number }
   - Order by lastActivity DESC (most recently active first)
   - Use aggregation pattern: query all events, reduce to unique projects with max timestamp

2. Create app/hooks/useProjectFilter.ts:
   - Export useProjectFilter() hook
   - Use useQueryState from nuqs with 'project' key
   - Use parseAsString parser (project is null when no param, string when set)
   - Return [project, setProject] tuple

Implementation for listProjects:
```typescript
export const listProjects = query({
  args: {},
  handler: async (ctx) => {
    // Get all events to extract unique projects
    const events = await ctx.db.query("events").collect();

    // Reduce to unique projects with most recent timestamp
    const projectMap = new Map<string, number>();
    for (const event of events) {
      const existing = projectMap.get(event.projectName) ?? 0;
      if (event.timestamp > existing) {
        projectMap.set(event.projectName, event.timestamp);
      }
    }

    // Convert to array and sort by lastActivity DESC
    return Array.from(projectMap.entries())
      .map(([name, lastActivity]) => ({ name, lastActivity }))
      .sort((a, b) => b.lastActivity - a.lastActivity);
  },
});
```

Implementation for useProjectFilter:
```typescript
'use client'
import { useQueryState, parseAsString } from 'nuqs'

export function useProjectFilter() {
  return useQueryState('project', parseAsString)
}
```
  </action>
  <verify>
- `bunx convex dev` runs without errors (schema/query compiles)
- `grep "listProjects" convex/events.ts` shows the query exists
- `grep "useQueryState" app/hooks/useProjectFilter.ts` shows the hook uses nuqs
  </verify>
  <done>listProjects query returns unique projects sorted by activity; useProjectFilter hook syncs with ?project= URL param</done>
</task>

</tasks>

<verification>
1. `bun run build` completes successfully
2. Dependencies in package.json: nuqs, react-collapsed, shiki
3. NuqsAdapter wrapping app content in layout.tsx
4. listProjects query exportable from convex/events.ts
5. useProjectFilter hook exportable from app/hooks/useProjectFilter.ts
</verification>

<success_criteria>
- All three dependencies installed and importable
- NuqsAdapter configured in app layout
- Convex listProjects query returns unique projects ordered by recent activity
- useProjectFilter hook provides URL-synced project state
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-layered-display-projects/03-01-SUMMARY.md`
</output>
