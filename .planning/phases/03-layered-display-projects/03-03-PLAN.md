---
phase: 03-layered-display-projects
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - app/components/sidebar/ProjectSidebar.tsx
  - app/components/sidebar/ProjectItem.tsx
  - app/hooks/useSidebarCollapse.ts
  - app/components/feed/CurrentlyIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "Project sidebar shows list of projects with activity indicators"
    - "Clicking a project sets the URL filter (?project=name)"
    - "Sidebar can be collapsed to icons-only mode"
    - "Sidebar collapse preference persists in localStorage"
    - "'Currently' indicator shows latest event summary at top of feed"
    - "'Currently' indicator has pulse animation when events are arriving"
  artifacts:
    - path: "app/components/sidebar/ProjectSidebar.tsx"
      provides: "Collapsible project list sidebar"
      exports: ["ProjectSidebar"]
    - path: "app/components/sidebar/ProjectItem.tsx"
      provides: "Individual project with activity dot"
      exports: ["ProjectItem"]
    - path: "app/hooks/useSidebarCollapse.ts"
      provides: "Hydration-safe localStorage persistence for sidebar state"
      exports: ["useSidebarCollapse"]
    - path: "app/components/feed/CurrentlyIndicator.tsx"
      provides: "Sticky indicator showing current activity"
      exports: ["CurrentlyIndicator"]
  key_links:
    - from: "app/components/sidebar/ProjectSidebar.tsx"
      to: "app/hooks/useProjectFilter.ts"
      via: "useProjectFilter for URL sync"
      pattern: "useProjectFilter"
    - from: "app/hooks/useSidebarCollapse.ts"
      to: "localStorage"
      via: "useEffect hydration pattern"
      pattern: "localStorage.*sidebar"
---

<objective>
Create the project sidebar with filtering capability and the "Currently" indicator showing live activity.

Purpose: Enables project filtering via sidebar (not dropdown per CONTEXT.md) and provides constant awareness of current activity via sticky indicator.
Output: ProjectSidebar with collapse, ProjectItem with activity dots, useSidebarCollapse hook, CurrentlyIndicator.
</objective>

<execution_context>
@/Users/alexander.buss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander.buss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-layered-display-projects/03-RESEARCH.md
@.planning/phases/03-layered-display-projects/03-CONTEXT.md
@.planning/phases/03-layered-display-projects/03-01-SUMMARY.md

# Reference for Convex projects query
@convex/events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSidebarCollapse hook with localStorage persistence</name>
  <files>app/hooks/useSidebarCollapse.ts</files>
  <action>
Create app/hooks/useSidebarCollapse.ts using hydration-safe localStorage pattern from RESEARCH.md:

- Initialize with default (not collapsed)
- Read localStorage in useEffect after mount
- Persist changes to localStorage
- Export hasMounted flag to prevent hydration mismatch
- Use 'sidebar-collapsed' as localStorage key

```typescript
'use client'

import { useState, useEffect, useCallback } from 'react'

const STORAGE_KEY = 'sidebar-collapsed'

export function useSidebarCollapse() {
  const [isCollapsed, setIsCollapsed] = useState(false)
  const [hasMounted, setHasMounted] = useState(false)

  // Read from localStorage after mount (hydration-safe)
  useEffect(() => {
    const stored = localStorage.getItem(STORAGE_KEY)
    if (stored !== null) {
      setIsCollapsed(stored === 'true')
    }
    setHasMounted(true)
  }, [])

  // Persist to localStorage on change
  useEffect(() => {
    if (hasMounted) {
      localStorage.setItem(STORAGE_KEY, String(isCollapsed))
    }
  }, [isCollapsed, hasMounted])

  const toggle = useCallback(() => {
    setIsCollapsed(prev => !prev)
  }, [])

  return { isCollapsed, setIsCollapsed, toggle, hasMounted }
}
```
  </action>
  <verify>
- `ls app/hooks/useSidebarCollapse.ts` shows file exists
- `grep "localStorage" app/hooks/useSidebarCollapse.ts` confirms localStorage usage
- `grep "hasMounted" app/hooks/useSidebarCollapse.ts` confirms hydration-safe pattern
  </verify>
  <done>useSidebarCollapse hook provides hydration-safe localStorage persistence for sidebar state</done>
</task>

<task type="auto">
  <name>Task 2: Create ProjectSidebar and ProjectItem components</name>
  <files>app/components/sidebar/ProjectSidebar.tsx, app/components/sidebar/ProjectItem.tsx</files>
  <action>
1. Create app/components/sidebar/ProjectItem.tsx:
   - Accept: name, lastActivity, isSelected, isActive, isCollapsed, onClick
   - Show project name (or icon when collapsed)
   - Activity indicator: green pulse dot if active (within last 5 min), gray dot otherwise
   - Selected state: different background color
   - Truncate long names when expanded

```typescript
'use client'

interface ProjectItemProps {
  name: string
  lastActivity: number
  isSelected: boolean
  isCollapsed: boolean
  onClick: () => void
}

export function ProjectItem({ name, lastActivity, isSelected, isCollapsed, onClick }: ProjectItemProps) {
  // Active if last activity within 5 minutes
  const isActive = Date.now() - lastActivity < 5 * 60 * 1000

  // First letter for collapsed icon
  const initial = name.charAt(0).toUpperCase()

  return (
    <button
      onClick={onClick}
      className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg transition-colors text-left
        ${isSelected ? 'bg-zinc-700 text-zinc-100' : 'text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200'}
        ${isCollapsed ? 'justify-center' : ''}`}
      title={isCollapsed ? name : undefined}
    >
      {/* Activity indicator */}
      <span className={`w-2 h-2 rounded-full shrink-0 ${isActive ? 'bg-green-500 animate-pulse' : 'bg-zinc-600'}`} />

      {isCollapsed ? (
        // Icon mode: show initial
        <span className="font-mono text-sm font-medium">{initial}</span>
      ) : (
        // Expanded mode: show full name
        <span className="font-mono text-sm truncate">{name}</span>
      )}
    </button>
  )
}
```

2. Create app/components/sidebar/ProjectSidebar.tsx:
   - Use useProjectFilter hook for URL sync
   - Use useSidebarCollapse for collapse state
   - Use Convex useQuery for listProjects
   - Collapse toggle button at bottom
   - Projects ordered by most recent activity (from query)
   - Handle loading and empty states
   - Keyboard shortcut: Cmd/Ctrl + B to toggle collapse

```typescript
'use client'

import { useQuery } from 'convex/react'
import { api } from '@/convex/_generated/api'
import { useEffect } from 'react'
import { useProjectFilter } from '@/app/hooks/useProjectFilter'
import { useSidebarCollapse } from '@/app/hooks/useSidebarCollapse'
import { ProjectItem } from './ProjectItem'

export function ProjectSidebar() {
  const [selectedProject, setSelectedProject] = useProjectFilter()
  const { isCollapsed, toggle, hasMounted } = useSidebarCollapse()
  const projects = useQuery(api.events.listProjects)

  // Keyboard shortcut: Cmd/Ctrl + B to toggle
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'b') {
        e.preventDefault()
        toggle()
      }
    }
    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [toggle])

  // Auto-select most recent project if none selected
  useEffect(() => {
    if (projects && projects.length > 0 && !selectedProject) {
      setSelectedProject(projects[0].name)
    }
  }, [projects, selectedProject, setSelectedProject])

  // Prevent hydration mismatch
  if (!hasMounted) {
    return (
      <aside className={`bg-zinc-900 border-r border-zinc-800 flex flex-col ${isCollapsed ? 'w-14' : 'w-48'}`}>
        <div className="flex-1 p-2" />
      </aside>
    )
  }

  return (
    <aside className={`bg-zinc-900 border-r border-zinc-800 flex flex-col transition-[width] duration-200 ${isCollapsed ? 'w-14' : 'w-48'}`}>
      {/* Header */}
      {!isCollapsed && (
        <div className="px-3 py-3 border-b border-zinc-800">
          <h2 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Projects</h2>
        </div>
      )}

      {/* Project list */}
      <nav className="flex-1 p-2 space-y-1 overflow-y-auto">
        {projects === undefined ? (
          // Loading
          <div className="space-y-2">
            {[1, 2, 3].map(i => (
              <div key={i} className="h-9 bg-zinc-800 rounded animate-pulse" />
            ))}
          </div>
        ) : projects.length === 0 ? (
          // Empty
          !isCollapsed && (
            <p className="text-xs text-zinc-600 px-2">No projects yet</p>
          )
        ) : (
          // Projects
          projects.map(project => (
            <ProjectItem
              key={project.name}
              name={project.name}
              lastActivity={project.lastActivity}
              isSelected={selectedProject === project.name}
              isCollapsed={isCollapsed}
              onClick={() => setSelectedProject(project.name)}
            />
          ))
        )}
      </nav>

      {/* Collapse toggle */}
      <div className="p-2 border-t border-zinc-800">
        <button
          onClick={toggle}
          className="w-full flex items-center justify-center gap-2 px-3 py-2 text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800 rounded transition-colors"
          title={isCollapsed ? 'Expand sidebar (⌘B)' : 'Collapse sidebar (⌘B)'}
        >
          <svg
            className={`w-4 h-4 transition-transform ${isCollapsed ? 'rotate-180' : ''}`}
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
          </svg>
          {!isCollapsed && <span className="text-xs">Collapse</span>}
        </button>
      </div>
    </aside>
  )
}
```
  </action>
  <verify>
- `ls app/components/sidebar/ProjectItem.tsx app/components/sidebar/ProjectSidebar.tsx` shows both files exist
- `grep "useProjectFilter" app/components/sidebar/ProjectSidebar.tsx` confirms URL sync
- `grep "useSidebarCollapse" app/components/sidebar/ProjectSidebar.tsx` confirms collapse integration
- `bun run build` passes
  </verify>
  <done>ProjectSidebar shows projects with activity indicators; clicking sets URL filter; collapse toggle persists to localStorage</done>
</task>

<task type="auto">
  <name>Task 3: Create CurrentlyIndicator component</name>
  <files>app/components/feed/CurrentlyIndicator.tsx</files>
  <action>
Create app/components/feed/CurrentlyIndicator.tsx:

- Show latest event summary (e.g., "Reading src/app/page.tsx")
- Sticky at top of feed area
- Pulse animation when receiving events (within last 10 seconds)
- Hidden when no events or no recent activity
- Generate summary text based on event type and tool

```typescript
'use client'

import type { Doc } from '@/convex/_generated/dataModel'

type Event = Doc<'events'>

interface CurrentlyIndicatorProps {
  event: Event | null
  isReceivingEvents: boolean
}

/**
 * Generate a human-readable summary of what Claude is currently doing
 */
function getSummary(event: Event): string {
  const tool = event.tool?.toLowerCase()

  // Extract file path if available
  const filePath = event.toolInput &&
    typeof event.toolInput === 'object' &&
    'file_path' in event.toolInput
    ? (event.toolInput as { file_path: string }).file_path
    : null

  // Extract command if Bash
  const command = event.toolInput &&
    typeof event.toolInput === 'object' &&
    'command' in event.toolInput
    ? (event.toolInput as { command: string }).command
    : null

  switch (tool) {
    case 'read':
      return filePath ? `Reading ${shortenPath(filePath)}` : 'Reading file'
    case 'write':
      return filePath ? `Writing ${shortenPath(filePath)}` : 'Writing file'
    case 'edit':
      return filePath ? `Editing ${shortenPath(filePath)}` : 'Editing file'
    case 'bash':
      return command ? `Running ${shortenCommand(command)}` : 'Running command'
    case 'glob':
      return 'Searching for files'
    case 'grep':
      return 'Searching file contents'
    default:
      if (event.type === 'user_prompt_submit') {
        return 'Processing prompt'
      }
      if (event.type === 'session_start') {
        return 'Session started'
      }
      return event.tool || event.type || 'Working...'
  }
}

function shortenPath(path: string): string {
  const parts = path.split('/')
  if (parts.length <= 3) return path
  return `${parts[0]}/.../${parts[parts.length - 1]}`
}

function shortenCommand(command: string): string {
  const firstLine = command.split('\n')[0]
  if (firstLine.length <= 40) return firstLine
  return firstLine.slice(0, 37) + '...'
}

export function CurrentlyIndicator({ event, isReceivingEvents }: CurrentlyIndicatorProps) {
  if (!event) return null

  const summary = getSummary(event)

  return (
    <div className="sticky top-0 z-10 bg-zinc-900/95 backdrop-blur border-b border-zinc-800 px-4 py-2">
      <div className="flex items-center gap-2">
        {/* Activity dot with conditional pulse */}
        <span
          className={`w-2 h-2 rounded-full shrink-0 ${
            isReceivingEvents ? 'bg-green-500 animate-pulse' : 'bg-zinc-600'
          }`}
        />
        <span className="text-sm text-zinc-300 truncate">
          {summary}
        </span>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
- `ls app/components/feed/CurrentlyIndicator.tsx` shows file exists
- `grep "sticky" app/components/feed/CurrentlyIndicator.tsx` confirms sticky positioning
- `grep "animate-pulse" app/components/feed/CurrentlyIndicator.tsx` confirms pulse animation
- `bun run build` passes
  </verify>
  <done>CurrentlyIndicator shows latest event summary with pulse animation when actively receiving events; sticky at top of feed</done>
</task>

</tasks>

<verification>
1. ProjectSidebar shows project list with activity indicators
2. Clicking project updates URL to ?project=name
3. Sidebar collapse toggle works and persists across page reload
4. Cmd/Ctrl + B keyboard shortcut toggles sidebar
5. CurrentlyIndicator shows summary of latest event
6. Pulse animation appears when events are arriving
7. `bun run build` passes
</verification>

<success_criteria>
- Project sidebar displays projects sorted by recent activity
- Clicking a project sets URL filter
- Sidebar can collapse to icons-only mode
- Collapse preference persists in localStorage
- "Currently" indicator shows at top with latest event summary
- Pulse animation when receiving events
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-layered-display-projects/03-03-SUMMARY.md`
</output>
