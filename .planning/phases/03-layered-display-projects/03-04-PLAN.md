---
phase: 03-layered-display-projects
plan: 04
type: execute
wave: 3
depends_on: [03-02, 03-03]
files_modified:
  - app/live/page.tsx
  - app/page.tsx
  - app/components/feed/EventFeed.tsx
  - app/components/ui/Header.tsx
autonomous: false

must_haves:
  truths:
    - "/live route displays sidebar + feed layout"
    - "URL ?project=name filters events to that project"
    - "Events expand/collapse on click"
    - "'Currently' indicator shows latest event"
    - "Home page redirects to /live or shows preview"
    - "Expand all / Collapse all buttons work in header"
  artifacts:
    - path: "app/live/page.tsx"
      provides: "Main live feed page with sidebar layout"
      min_lines: 40
    - path: "app/components/feed/EventFeed.tsx"
      provides: "Updated feed with expand/collapse and project filter"
      min_lines: 60
  key_links:
    - from: "app/live/page.tsx"
      to: "app/components/sidebar/ProjectSidebar.tsx"
      via: "Sidebar component import"
      pattern: "ProjectSidebar"
    - from: "app/components/feed/EventFeed.tsx"
      to: "app/hooks/useProjectFilter.ts"
      via: "Project filter URL sync"
      pattern: "useProjectFilter"
    - from: "app/components/feed/EventFeed.tsx"
      to: "convex/events.ts"
      via: "listEvents with projectName filter"
      pattern: "listEvents.*projectName"
---

<objective>
Integrate all Phase 3 components into the /live page layout and verify the complete feature works.

Purpose: Delivers the complete layered display and project filtering experience on the /live route.
Output: Working /live page with sidebar, expandable events, project filtering, and "Currently" indicator.
</objective>

<execution_context>
@/Users/alexander.buss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander.buss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-layered-display-projects/03-RESEARCH.md
@.planning/phases/03-layered-display-projects/03-CONTEXT.md
@.planning/phases/03-layered-display-projects/03-01-SUMMARY.md
@.planning/phases/03-layered-display-projects/03-02-SUMMARY.md
@.planning/phases/03-layered-display-projects/03-03-SUMMARY.md

# Existing files to modify
@app/components/feed/EventFeed.tsx
@app/components/ui/Header.tsx
@app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update EventFeed with expand/collapse and project filter</name>
  <files>app/components/feed/EventFeed.tsx</files>
  <action>
Update app/components/feed/EventFeed.tsx to:

1. Use useProjectFilter to get selected project from URL
2. Pass projectName to listEvents query for filtering
3. Use useExpandedEvents hook to manage expanded state
4. Pass isExpanded and onToggle to each EventCard
5. Add CurrentlyIndicator at top of feed
6. Track isReceivingEvents (event arrived in last 10 seconds)
7. Export expandAll and collapseAll for Header to call

```typescript
'use client'

import { useQuery } from 'convex/react'
import { api } from '@/convex/_generated/api'
import { useState, useEffect, useCallback } from 'react'
import { EventCard } from './EventCard'
import { NewEventsIndicator } from './NewEventsIndicator'
import { CurrentlyIndicator } from './CurrentlyIndicator'
import { useNewEventsIndicator } from './hooks/useNewEventsIndicator'
import { useExpandedEvents } from '@/app/hooks/useExpandedEvents'
import { useProjectFilter } from '@/app/hooks/useProjectFilter'

function EventSkeleton() { /* ... keep existing ... */ }

interface EventFeedProps {
  onExpandCollapseChange?: (handlers: { expandAll: () => void; collapseAll: () => void }) => void
}

export function EventFeed({ onExpandCollapseChange }: EventFeedProps) {
  const [selectedProject] = useProjectFilter()

  // Track which events were present on initial load
  const [initialEventIds, setInitialEventIds] = useState<Set<string>>(new Set())
  const [hasInitialLoad, setHasInitialLoad] = useState(false)

  // Subscribe to real-time events, filtered by project
  const events = useQuery(api.events.listEvents, {
    projectName: selectedProject ?? undefined,
    limit: 100
  })

  // Manage expanded state for all events
  const { isExpanded, toggle, expandAll, collapseAll } = useExpandedEvents()

  // Expose expand/collapse handlers to parent (Header)
  useEffect(() => {
    if (onExpandCollapseChange && events) {
      onExpandCollapseChange({
        expandAll: () => expandAll(events.map(e => e._id)),
        collapseAll
      })
    }
  }, [onExpandCollapseChange, events, expandAll, collapseAll])

  // Capture initial event IDs on first data load
  useEffect(() => {
    if (!hasInitialLoad && events !== undefined) {
      setInitialEventIds(new Set(events.map(e => e._id)))
      setHasInitialLoad(true)
    }
  }, [events, hasInitialLoad])

  // Track new events indicator
  const eventIds = events?.map(e => e._id) ?? []
  const { containerRef, newEventCount, scrollToTop } = useNewEventsIndicator(eventIds)

  // Track if we're actively receiving events (for CurrentlyIndicator pulse)
  const [isReceivingEvents, setIsReceivingEvents] = useState(false)
  const [lastEventTime, setLastEventTime] = useState(0)

  useEffect(() => {
    if (events && events.length > 0) {
      const latestTimestamp = events[0].timestamp
      if (latestTimestamp > lastEventTime) {
        setLastEventTime(latestTimestamp)
        setIsReceivingEvents(true)
        // Clear "receiving" state after 10 seconds of no new events
        const timeout = setTimeout(() => setIsReceivingEvents(false), 10000)
        return () => clearTimeout(timeout)
      }
    }
  }, [events, lastEventTime])

  // Loading state
  if (events === undefined) {
    return (
      <div className="flex flex-col h-full overflow-hidden">
        <div className="flex-1 overflow-y-auto px-4 py-2 space-y-1">
          {[...Array(5)].map((_, i) => <EventSkeleton key={i} />)}
        </div>
      </div>
    )
  }

  // Empty state
  if (events.length === 0) {
    return (
      <div className="flex flex-col h-full overflow-hidden">
        <div className="flex-1 flex items-center justify-center">
          <p className="text-zinc-500 text-center py-8">
            No events yet{selectedProject ? ` for ${selectedProject}` : ''}.
            <br />
            <span className="text-sm">
              Events will appear here when Claude Code is active.
            </span>
          </p>
        </div>
      </div>
    )
  }

  const latestEvent = events[0]

  return (
    <div className="flex flex-col h-full overflow-hidden">
      {/* Currently indicator */}
      <CurrentlyIndicator event={latestEvent} isReceivingEvents={isReceivingEvents} />

      {/* New events banner */}
      <NewEventsIndicator count={newEventCount} onClick={scrollToTop} />

      {/* Event list */}
      <div ref={containerRef} className="flex-1 overflow-y-auto px-4 py-2 space-y-1">
        {events.map(event => (
          <EventCard
            key={event._id}
            event={event}
            isNew={hasInitialLoad && !initialEventIds.has(event._id)}
            isExpanded={isExpanded(event._id)}
            onToggle={() => toggle(event._id)}
          />
        ))}
      </div>
    </div>
  )
}
```
  </action>
  <verify>
- `grep "useProjectFilter" app/components/feed/EventFeed.tsx` confirms project filter integration
- `grep "useExpandedEvents" app/components/feed/EventFeed.tsx` confirms expand state management
- `grep "CurrentlyIndicator" app/components/feed/EventFeed.tsx` confirms currently indicator usage
- `bun run build` passes
  </verify>
  <done>EventFeed integrates project filtering, expand/collapse state, and CurrentlyIndicator</done>
</task>

<task type="auto">
  <name>Task 2: Update Header with expand/collapse all buttons</name>
  <files>app/components/ui/Header.tsx</files>
  <action>
Update app/components/ui/Header.tsx to add "Expand all" and "Collapse all" buttons:

- Accept optional onExpandAll and onCollapseAll callbacks
- Show buttons only when callbacks provided
- Use simple text buttons with subtle styling
- Position on right side of header

```typescript
'use client'

import { ConnectionStatus } from '@/app/components/feed/ConnectionStatus'

interface HeaderProps {
  onExpandAll?: () => void
  onCollapseAll?: () => void
}

export function Header({ onExpandAll, onCollapseAll }: HeaderProps) {
  return (
    <header className="sticky top-0 z-20 bg-zinc-950 border-b border-zinc-800 px-4 py-3">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <h1 className="text-lg font-bold text-zinc-100">agentstype.dev</h1>
          <ConnectionStatus />
        </div>

        {/* Expand/Collapse buttons */}
        {(onExpandAll || onCollapseAll) && (
          <div className="flex items-center gap-2">
            {onExpandAll && (
              <button
                onClick={onExpandAll}
                className="text-xs text-zinc-500 hover:text-zinc-300 transition-colors"
              >
                Expand all
              </button>
            )}
            {onCollapseAll && (
              <button
                onClick={onCollapseAll}
                className="text-xs text-zinc-500 hover:text-zinc-300 transition-colors"
              >
                Collapse all
              </button>
            )}
          </div>
        )}
      </div>
    </header>
  )
}
```
  </action>
  <verify>
- `grep "onExpandAll" app/components/ui/Header.tsx` confirms expand all prop
- `grep "onCollapseAll" app/components/ui/Header.tsx` confirms collapse all prop
- `bun run build` passes
  </verify>
  <done>Header has expand/collapse all buttons that can be wired to EventFeed</done>
</task>

<task type="auto">
  <name>Task 3: Create /live page and update home page</name>
  <files>app/live/page.tsx, app/page.tsx</files>
  <action>
1. Create app/live/page.tsx with sidebar + feed layout:
   - Full-height flex layout
   - ProjectSidebar on left
   - Main content area with Header and EventFeed
   - Wire up expand/collapse handlers between Header and EventFeed
   - Use useState to hold the handler references

```typescript
'use client'

import { useState, useCallback } from 'react'
import { Header } from '@/app/components/ui/Header'
import { EventFeed } from '@/app/components/feed/EventFeed'
import { ProjectSidebar } from '@/app/components/sidebar/ProjectSidebar'

export default function LivePage() {
  const [expandCollapseHandlers, setExpandCollapseHandlers] = useState<{
    expandAll: () => void
    collapseAll: () => void
  } | null>(null)

  const handleExpandCollapseChange = useCallback((handlers: { expandAll: () => void; collapseAll: () => void }) => {
    setExpandCollapseHandlers(handlers)
  }, [])

  return (
    <div className="flex h-screen bg-background">
      {/* Project sidebar */}
      <ProjectSidebar />

      {/* Main content */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header
          onExpandAll={expandCollapseHandlers?.expandAll}
          onCollapseAll={expandCollapseHandlers?.collapseAll}
        />
        <main className="flex-1 overflow-hidden">
          <EventFeed onExpandCollapseChange={handleExpandCollapseChange} />
        </main>
      </div>
    </div>
  )
}
```

2. Update app/page.tsx to redirect to /live or show a simple landing:
   - For now, redirect to /live using next/navigation
   - Alternative: Show a simple landing with link to /live

```typescript
import { redirect } from 'next/navigation'

export default function Home() {
  redirect('/live')
}
```
  </action>
  <verify>
- `ls app/live/page.tsx` shows live page exists
- `grep "ProjectSidebar" app/live/page.tsx` confirms sidebar integration
- `grep "redirect" app/page.tsx` or `grep "Link" app/page.tsx` confirms navigation to /live
- `bun run build` passes
  </verify>
  <done>/live page displays full layout with sidebar and feed; home page redirects to /live</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 3 implementation:
- Expand/collapse event cards with smooth animation
- Project sidebar with filtering
- URL sync (?project=name)
- "Currently" indicator with pulse
- Syntax highlighting in expanded view
- Expand all / Collapse all buttons
  </what-built>
  <how-to-verify>
1. Start the dev server: `bun dev` and `bunx convex dev`

2. Navigate to http://localhost:3000 (should redirect to /live)

3. **Project Sidebar:**
   - Verify sidebar shows project list
   - Click a project - URL should update to ?project=name
   - Verify feed filters to that project
   - Click collapse button (or Cmd+B) - sidebar should collapse to icons
   - Refresh page - collapse state should persist

4. **Expand/Collapse:**
   - Click any event card - should expand with animation
   - Click again - should collapse
   - Expand multiple events - all should stay expanded (not accordion)
   - Check expanded content shows tool inputs/outputs
   - Verify syntax highlighting in code blocks
   - Click "Expand all" in header - all events expand
   - Click "Collapse all" - all events collapse

5. **Currently Indicator:**
   - Verify "Currently:" shows latest event summary at top
   - When new events arrive, pulse animation should appear

6. **URL Sharing:**
   - Copy URL with ?project=name
   - Open in new tab - should filter to that project

Report any issues or confirm all features work as expected.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 3, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. /live route shows sidebar + feed layout
2. Clicking project updates URL and filters events
3. Event cards expand/collapse with smooth animation
4. Multiple events can be expanded simultaneously
5. "Currently" indicator shows latest event with pulse when active
6. Expand all / Collapse all buttons work
7. Sidebar collapse persists across page reload
8. URL sharing works (?project=name loads correct project)
</verification>

<success_criteria>
- Complete Phase 3 feature set working on /live page
- All requirements LAYER-01 through LAYER-04 satisfied
- All requirements PROJ-01 through PROJ-04 satisfied
- Visual verification checkpoint passed
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-layered-display-projects/03-04-SUMMARY.md`
</output>
