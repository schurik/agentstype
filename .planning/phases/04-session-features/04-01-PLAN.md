---
phase: 04-session-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - convex/events.ts
  - app/hooks/useSessionFilter.ts
  - app/hooks/useAgentFilter.ts
autonomous: true

must_haves:
  truths:
    - "Sessions for a project are queryable by project name"
    - "Agents for a session are queryable by session ID"
    - "URL state reflects session selection (?session=xyz)"
    - "URL state reflects agent selection (?agent=xyz)"
    - "Events can be filtered by agentId in addition to project and session"
  artifacts:
    - path: "convex/events.ts"
      provides: "listSessionsForProject and listAgentsForSession queries"
      exports: ["listSessionsForProject", "listAgentsForSession"]
    - path: "app/hooks/useSessionFilter.ts"
      provides: "URL-synced session filter hook"
      exports: ["useSessionFilter"]
    - path: "app/hooks/useAgentFilter.ts"
      provides: "URL-synced agent filter hook"
      exports: ["useAgentFilter"]
  key_links:
    - from: "convex/events.ts"
      to: "events table"
      via: "by_project and by_session indexes"
      pattern: "withIndex.*by_project|by_session"
    - from: "app/hooks/useSessionFilter.ts"
      to: "nuqs"
      via: "useQueryState"
      pattern: "useQueryState.*session"
---

<objective>
Create backend queries and URL state hooks for session and agent filtering

Purpose: Enable the sidebar to query sessions per project and agents per session, and allow URL-based session/agent selection
Output: Convex queries for session/agent lists, nuqs hooks for URL state, updated listEvents with agentId filter
</objective>

<execution_context>
@/Users/alexander.buss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander.buss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-session-features/04-RESEARCH.md

# Prior work - URL state pattern
@.planning/phases/03-layered-display-projects/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install date-fns and create Convex queries</name>
  <files>package.json, convex/events.ts</files>
  <action>
    1. Install date-fns for duration formatting:
       `bun add date-fns`

    2. Add listSessionsForProject query to convex/events.ts:
       - Args: { projectName: v.string() }
       - Use by_project index to get all events for project
       - Reduce to unique sessions with metadata:
         - sessionId, firstTimestamp, lastTimestamp, eventCount
         - goal (from first user_prompt_submit event's prompt field)
         - hasEnded (presence of session_end event)
       - Sort by lastTimestamp DESC (most recent first)
       - Return array of session objects

    3. Add listAgentsForSession query to convex/events.ts:
       - Args: { sessionId: v.string() }
       - Use by_session index to get all events for session
       - Find agents from subagent_start events (check agentId field)
       - For each agent, count total events (events with matching agentId)
       - Extract agentType from subagent_start event
       - Return array: { agentId, agentType, eventCount }

    4. Update listEvents query to support agentId filter:
       - Add agentId: v.optional(v.string()) to args
       - If agentId provided with sessionId, filter results by agentId after query
       - (Note: No index on agentId, so post-filter. Fine for small datasets.)

    Pattern reference from 04-RESEARCH.md for session aggregation.
  </action>
  <verify>
    `bunx convex dev` compiles without errors
    Check convex/_generated/api.d.ts includes listSessionsForProject and listAgentsForSession
  </verify>
  <done>
    date-fns installed, both Convex queries work, listEvents supports agentId filter
  </done>
</task>

<task type="auto">
  <name>Task 2: Create URL state hooks for session and agent</name>
  <files>app/hooks/useSessionFilter.ts, app/hooks/useAgentFilter.ts</files>
  <action>
    1. Create app/hooks/useSessionFilter.ts:
       - Follow exact pattern from useProjectFilter.ts
       - 'use client' directive
       - Import useQueryState, parseAsString from 'nuqs'
       - Export useSessionFilter hook returning useQueryState('session', parseAsString)

    2. Create app/hooks/useAgentFilter.ts:
       - Same pattern as above
       - Export useAgentFilter hook returning useQueryState('agent', parseAsString)

    Both hooks enable URL-synced state: /live?project=foo&session=abc&agent=xyz
  </action>
  <verify>
    TypeScript compilation passes (no red squiggles in editor)
    Both hooks export correctly: `import { useSessionFilter } from '@/app/hooks/useSessionFilter'`
  </verify>
  <done>
    Both hooks created following existing useProjectFilter pattern, ready for use in sidebar
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes
2. Convex queries appear in generated API
3. Hooks can be imported without errors
</verification>

<success_criteria>
- date-fns installed
- listSessionsForProject query returns sessions with goal, eventCount, hasEnded
- listAgentsForSession query returns agents with agentType, eventCount
- listEvents accepts optional agentId filter
- useSessionFilter and useAgentFilter hooks work with nuqs
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-features/04-01-SUMMARY.md`
</output>
