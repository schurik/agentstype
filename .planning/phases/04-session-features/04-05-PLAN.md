---
phase: 04-session-features
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/hooks/useSessionStats.ts
  - app/components/feed/EventFeed.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Session stats eventCount shows total events for the entire session, not limited to 100"
  artifacts:
    - path: "app/hooks/useSessionStats.ts"
      provides: "Accepts totalEventCount parameter for accurate count"
    - path: "app/components/feed/EventFeed.tsx"
      provides: "Passes session eventCount from listSessionsForProject to useSessionStats"
  key_links:
    - from: "app/components/feed/EventFeed.tsx"
      to: "useSessionStats"
      via: "totalEventCount parameter"
      pattern: "useSessionStats.*totalEventCount"
---

<objective>
Fix session stats event count to use accurate count from listSessionsForProject instead of computing from limited 100-event array.

Purpose: UAT Test 7 failed because eventCount shows only events from the limited feed query (max 100) rather than the total session event count.

Output: Session header stats show accurate total event count for entire session.
</objective>

<execution_context>
@/Users/alexander.buss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander.buss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-session-features/04-UAT.md

# Key source files
@app/hooks/useSessionStats.ts
@app/components/feed/EventFeed.tsx
@convex/events.ts (listSessionsForProject already computes accurate eventCount)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update useSessionStats to accept totalEventCount</name>
  <files>app/hooks/useSessionStats.ts</files>
  <action>
Add an optional `totalEventCount` parameter to useSessionStats:

1. Add third parameter: `totalEventCount?: number`
2. In the return object, use `totalEventCount` if provided, otherwise fall back to computing from events array
3. Update JSDoc to document the new parameter

The signature should become:
```typescript
export function useSessionStats(
  events: Event[] | undefined,
  sessionId: string | null,
  totalEventCount?: number
): SessionStats | null
```

And the eventCount line (around line 45-47) should become:
```typescript
const eventCount = totalEventCount ?? sessionEvents.filter(
  (e) => !['session_start', 'session_end'].includes(e.type)
).length
```

This maintains backward compatibility - callers that don't pass totalEventCount get the old behavior.
  </action>
  <verify>TypeScript compiles without errors: `bunx tsc --noEmit`</verify>
  <done>useSessionStats accepts optional totalEventCount and uses it when provided</done>
</task>

<task type="auto">
  <name>Task 2: Wire session eventCount through EventFeed</name>
  <files>app/components/feed/EventFeed.tsx</files>
  <action>
EventFeed already has access to session data via ProjectSidebar's query, but the eventCount isn't passed to useSessionStats. The cleanest fix:

1. Add a useQuery call to fetch the selected session's data directly:
```typescript
const sessionData = useQuery(
  api.events.listSessionsForProject,
  selectedProject ? { projectName: selectedProject } : 'skip'
)
```

2. Find the matching session from the result:
```typescript
const currentSession = useMemo(() => {
  if (!sessionData || !selectedSession) return null
  return sessionData.find(s => s.sessionId === selectedSession) ?? null
}, [sessionData, selectedSession])
```

3. Pass the accurate eventCount to useSessionStats:
```typescript
const stats = useSessionStats(events, selectedSession, currentSession?.eventCount)
```

Note: This adds one more Convex query subscription in EventFeed when a session is selected, but:
- The data is already being fetched by ProjectSidebar, so Convex will deduplicate
- It's the cleanest solution that doesn't require prop drilling through multiple components
  </action>
  <verify>
1. `bunx tsc --noEmit` passes
2. Select a session with many events (>100), expand stats - eventCount should show the full count, not capped at ~100
  </verify>
  <done>EventFeed passes accurate session eventCount to useSessionStats, showing total events not limited count</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `bunx tsc --noEmit`
2. Dev server runs: `bun dev` (no console errors)
3. Manual test: Select a session with >100 events, check stats eventCount matches total session events
</verification>

<success_criteria>
- Session stats eventCount shows accurate total (e.g., 247 events) not limited count (e.g., 100 events)
- UAT Test 7 would pass on re-test
- No TypeScript errors
- No regressions to other stats (duration, files, commits)
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-features/04-05-SUMMARY.md`
</output>
