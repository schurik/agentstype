---
phase: 04-session-features
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/components/sidebar/SessionItem.tsx
  - app/components/sidebar/AgentItem.tsx
  - app/components/sidebar/ProjectSidebar.tsx
  - app/components/sidebar/ProjectItem.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar shows Projects > Sessions > Agents hierarchy"
    - "Sessions are listed under each project when project is expanded"
    - "Agents are listed under each session when session is selected"
    - "Clicking a session filters the feed to that session"
    - "Clicking an agent filters the feed to that agent's events"
    - "Live sessions show green pulse, completed sessions show gray dot"
  artifacts:
    - path: "app/components/sidebar/SessionItem.tsx"
      provides: "Session row component with goal preview and status indicator"
      exports: ["SessionItem"]
    - path: "app/components/sidebar/AgentItem.tsx"
      provides: "Agent row component with event count"
      exports: ["AgentItem"]
    - path: "app/components/sidebar/ProjectSidebar.tsx"
      provides: "Extended sidebar with session/agent hierarchy"
      min_lines: 80
  key_links:
    - from: "app/components/sidebar/ProjectSidebar.tsx"
      to: "convex/events.ts"
      via: "useQuery"
      pattern: "listSessionsForProject"
    - from: "app/components/sidebar/ProjectSidebar.tsx"
      to: "app/hooks/useSessionFilter.ts"
      via: "hook import"
      pattern: "useSessionFilter"
---

<objective>
Extend sidebar with session and agent hierarchy beneath projects

Purpose: Enable users to navigate Project > Session > Agent hierarchy and filter the feed at each level
Output: SessionItem and AgentItem components, extended ProjectSidebar with nested collapsible sections
</objective>

<execution_context>
@/Users/alexander.buss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander.buss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-session-features/04-RESEARCH.md
@.planning/phases/04-session-features/04-CONTEXT.md
@.planning/phases/04-session-features/04-01-SUMMARY.md
@app/components/sidebar/ProjectSidebar.tsx
@app/components/sidebar/ProjectItem.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionItem and AgentItem components</name>
  <files>app/components/sidebar/SessionItem.tsx, app/components/sidebar/AgentItem.tsx</files>
  <action>
    1. Create app/components/sidebar/SessionItem.tsx:
       - 'use client' directive
       - Props:
         - sessionId: string
         - goal: string | null
         - firstTimestamp: number
         - hasEnded: boolean
         - eventCount: number
         - isSelected: boolean
         - isCollapsed: boolean (sidebar collapsed state)
         - onClick: () => void
       - Display:
         - Status dot: green animate-pulse if !hasEnded AND recent (5 min), gray otherwise
         - Label: format firstTimestamp as "Session h:mma" (e.g., "Session 2:30pm")
         - Goal on hover via title attribute
         - Event count badge (if not collapsed)
       - Styling: pl-6 (indent under project), hover:bg-zinc-800/50
       - When collapsed sidebar, show only status dot

    2. Create app/components/sidebar/AgentItem.tsx:
       - 'use client' directive
       - Props:
         - agentId: string
         - agentType: string | null
         - eventCount: number
         - isSelected: boolean
         - isCollapsed: boolean
         - onClick: () => void
       - Display:
         - Robot icon or agent type icon
         - Label: agentType or "Agent" if null
         - Event count badge
       - Styling: pl-10 (deeper indent under session)
       - When collapsed, show only icon

    Use formatTime from '@/app/lib/formatters' for timestamp formatting.
  </action>
  <verify>
    TypeScript compiles without errors
    Components can be imported and rendered
  </verify>
  <done>
    SessionItem shows status dot, timestamp label, goal preview
    AgentItem shows type label and event count
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend ProjectItem to show sessions when selected</name>
  <files>app/components/sidebar/ProjectItem.tsx</files>
  <action>
    1. Update ProjectItem.tsx:
       - Add props:
         - isExpanded: boolean
         - onToggleExpand: () => void
         - sessions: array from listSessionsForProject (or undefined if loading)
         - selectedSession: string | null
         - onSelectSession: (sessionId: string) => void
         - selectedAgent: string | null
         - onSelectAgent: (agentId: string | null) => void
       - Add expand/collapse chevron icon next to project name
       - When isExpanded, render sessions using SessionItem
       - When a session is selected, fetch and render agents using AgentItem

    2. Handle loading states:
       - Sessions undefined: show shimmer placeholder
       - Sessions empty: show "No sessions" text

    3. Clicking project name now:
       - Toggles expand
       - Selects project (clears session and agent selection)
  </action>
  <verify>
    TypeScript compiles without errors
    ProjectItem renders without crashing
  </verify>
  <done>
    ProjectItem expands to show sessions, sessions expand to show agents
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ProjectSidebar to manage session/agent state</name>
  <files>app/components/sidebar/ProjectSidebar.tsx</files>
  <action>
    1. Import new hooks and queries:
       - import { useSessionFilter } from '@/app/hooks/useSessionFilter'
       - import { useAgentFilter } from '@/app/hooks/useAgentFilter'
       - Add useQuery for api.events.listSessionsForProject (conditionally when project selected)
       - Add useQuery for api.events.listAgentsForSession (conditionally when session selected)

    2. Add state for expanded projects:
       - useState<Set<string>> for expandedProjects
       - When project selected, auto-expand it

    3. Update project list rendering:
       - Pass sessions to ProjectItem
       - Pass selectedSession/selectedAgent to ProjectItem
       - Pass handlers for session/agent selection
       - Wire up expand/collapse

    4. Handle URL state cascade:
       - When project changes, clear session and agent
       - When session changes, clear agent
       - useEffect to enforce this hierarchy

    5. Update "Projects" header to be "Navigation" or keep as "Projects"
       (sidebar now has more than just projects)
  </action>
  <verify>
    TypeScript compiles without errors
    `bun run build` passes
  </verify>
  <done>
    Sidebar displays full Project > Session > Agent hierarchy
    URL state updates correctly when navigating hierarchy
    Selecting any level filters the feed appropriately
  </done>
</task>

</tasks>

<verification>
1. `bun run build` passes
2. Sidebar hierarchy is navigable (visually verify in later plan)
3. URL updates when selecting session/agent
</verification>

<success_criteria>
- SessionItem displays status dot, time label, goal preview, event count
- AgentItem displays type and event count
- ProjectItem expands to show sessions, sessions show agents
- ProjectSidebar manages the full hierarchy state
- URL reflects selection: ?project=foo&session=abc&agent=xyz
- Selecting project clears session/agent, selecting session clears agent
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-features/04-03-SUMMARY.md`
</output>
