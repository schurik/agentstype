---
phase: 06-performance-scale
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - convex/convex.config.ts
  - convex/presence.ts
autonomous: true

must_haves:
  truths:
    - "Backend can track and report active viewers"
    - "Presence functions are available for heartbeat and listing viewers"
  artifacts:
    - path: "package.json"
      provides: "New dependencies"
      contains: "@tanstack/react-virtual"
    - path: "package.json"
      provides: "New dependencies"
      contains: "@convex-dev/presence"
    - path: "convex/convex.config.ts"
      provides: "Convex app configuration with presence component"
      exports: ["default"]
    - path: "convex/presence.ts"
      provides: "Presence mutations and queries"
      exports: ["heartbeat", "listViewers"]
  key_links:
    - from: "convex/convex.config.ts"
      to: "@convex-dev/presence"
      via: "app.use(presence)"
      pattern: "app\\.use\\(presence\\)"
    - from: "convex/presence.ts"
      to: "convex/convex.config.ts"
      via: "components import"
      pattern: "components\\.presence"
---

<objective>
Install performance and presence dependencies, then set up Convex presence for real-time viewer counting.

Purpose: Enable virtualization library and real-time viewer presence tracking as foundation for Phase 6 features.
Output: Dependencies installed, Convex presence component configured and ready for use.
</objective>

<execution_context>
@/Users/alexander.buss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander.buss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-performance-scale/06-CONTEXT.md
@.planning/phases/06-performance-scale/06-RESEARCH.md
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies</name>
  <files>package.json</files>
  <action>
Install the two new dependencies required for Phase 6:

```bash
bun add @tanstack/react-virtual @convex-dev/presence
```

@tanstack/react-virtual (^3.13): Headless virtualization for the event feed
@convex-dev/presence (latest): Real-time presence for viewer count

These are the recommended libraries from RESEARCH.md - do NOT use react-window or custom presence implementations.
  </action>
  <verify>Run `bun install` completes without error. Check package.json contains both "@tanstack/react-virtual" and "@convex-dev/presence".</verify>
  <done>Both dependencies are listed in package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Convex presence component</name>
  <files>convex/convex.config.ts, convex/presence.ts</files>
  <action>
Create Convex app configuration to include the presence component:

**convex/convex.config.ts:**
```typescript
import { defineApp } from "convex/server";
import presence from "@convex-dev/presence/convex.config";

const app = defineApp();
app.use(presence);
export default app;
```

**convex/presence.ts:**
Create presence wrapper functions for viewer tracking:

```typescript
import { mutation, query } from "./_generated/server";
import { components } from "./_generated/api";
import { v } from "convex/values";
import { Presence } from "@convex-dev/presence";

const presence = new Presence(components.presence);

// Send heartbeat to track viewer presence
// Room format: "projectName:sessionId" for granular tracking
// Client passes stable userId (generated once per browser session via sessionStorage)
export const heartbeat = mutation({
  args: {
    room: v.string(), // Format: "projectName" or "projectName:sessionId"
    userId: v.string(), // Stable ID from client (e.g., "viewer-{timestamp}-{random}")
  },
  handler: async (ctx, { room, userId }) => {
    // Heartbeat with 10 second TTL (presence auto-removes stale entries)
    return await presence.heartbeat(ctx, room, userId, {}, 10000);
  },
});

// List current viewers in a room
export const listViewers = query({
  args: {
    room: v.string(),
  },
  handler: async (ctx, { room }) => {
    return await presence.list(ctx, room);
  },
});
```

Key decisions:
- Room format is flexible ("projectName" for project-wide, "projectName:sessionId" for session-specific)
- 10 second TTL matches the 5-second heartbeat interval with buffer
- Client generates stable userId once per session and passes it to heartbeat mutation (prevents duplicate viewers)
- Anonymous user IDs - no authentication needed for read-only viewer count
  </action>
  <verify>Run `bunx convex dev` and verify it deploys without errors. Verify presence:presence_data table appears in Convex dashboard under "Data". Test heartbeat mutation via Convex dashboard Functions tab: call `presence:heartbeat` with args `{ room: "test", userId: "test-user" }` and verify no error.</verify>
  <done>Convex presence component is configured. heartbeat mutation accepts userId parameter and listViewers query are deployed and functional.</done>
</task>

</tasks>

<verification>
1. `bun install` shows both new packages
2. `bunx convex dev` deploys successfully with presence component
3. Convex dashboard shows presence:presence_data table
4. Calling heartbeat mutation with same userId twice does not create duplicate entries
</verification>

<success_criteria>
- package.json contains @tanstack/react-virtual and @convex-dev/presence
- convex/convex.config.ts exists and uses presence component
- convex/presence.ts exports heartbeat (accepting userId parameter) and listViewers
- Convex deployment succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-performance-scale/06-01-SUMMARY.md`
</output>
